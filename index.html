<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebKit Sandbox Escape Fuzzer</title>
  <style>
    body { font-family: monospace; background: #111; color: #0f0; padding: 1em; }
    canvas, video { display: block; margin-top: 10px; }
    .log { height: 200px; overflow-y: scroll; background: #000; padding: 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>ðŸ§ª WebKit + AVFoundation Fuzz Target</h1>
  <button onclick="startFuzzing()">Start Fuzz</button>
  <button onclick="stopFuzzing()">Stop</button>
  <canvas id="canvas" width="64" height="64"></canvas>
  <video id="video" autoplay muted playsinline></video>
  <div class="log" id="log">Logs will appear here...</div>

  <script>
    const log = msg => {
      const l = document.getElementById("log");
      l.innerText += "\n" + msg;
      l.scrollTop = l.scrollHeight;
    };

    let loop;
    function startFuzzing() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      loop = setInterval(() => {
        try {
          // Draw random junk pixels
          let imgData = ctx.createImageData(canvas.width, canvas.height);
          for (let i = 0; i < imgData.data.length; i++) {
            imgData.data[i] = Math.floor(Math.random() * 256);
          }
          ctx.putImageData(imgData, 0, 0);

          // Encode canvas to Blob
          canvas.toBlob(blob => {
            // Use the blob as an Image source (decode pipeline)
            const img = new Image();
            img.onload = () => {
              // Re-draw decoded image onto canvas
              ctx.drawImage(img, 0, 0);
              log("[+] Redrew decoded image frame");
            };
            img.onerror = err => log("[!] Image decode failed");
            img.src = URL.createObjectURL(blob);
          }, 'image/png');

        } catch (err) {
          log("[!] Error: " + err.message);
        }
      }, 500);

      log("[*] Canvas fuzzing loop started");

      // Start getUserMedia and pipe to video (video parsing path)
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const video = document.getElementById("video");
          video.srcObject = stream;
          log("[*] Camera stream started");
        })
        .catch(err => log("[!] Camera error: " + err.message));
    }

    function stopFuzzing() {
      clearInterval(loop);
      log("[*] Fuzzing stopped");
    }
  </script>
</body>
</html>
