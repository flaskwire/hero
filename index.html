<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebKit Advanced Fuzzer</title>
  <style>
    body { font-family: monospace; background: #111; color: #0f0; padding: 1em; }
    canvas, video { display: block; margin-top: 10px; }
    .log { height: 200px; overflow-y: scroll; background: #000; padding: 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>ðŸ§¨ Advanced WebKit + AVFoundation Fuzzer</h1>
  <button onclick="startFuzzing()">Start Fuzz</button>
  <button onclick="stopFuzzing()">Stop</button>
  <canvas id="canvas" width="1024" height="1024"></canvas>
  <video id="video" autoplay muted playsinline></video>
  <div class="log" id="log">Logs will appear here...</div>

  <script>
    const log = msg => {
      const l = document.getElementById("log");
      l.innerText += "\n" + msg;
      l.scrollTop = l.scrollHeight;
    };

    let loop;
    function startFuzzing() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = 1024;
      canvas.height = 1024;

      loop = setInterval(() => {
        try {
          // Apply extreme filters randomly
          const filters = [
            'blur(500px)', 'contrast(9999%)', 'brightness(0%)',
            'invert(100%)', 'grayscale(100%)', 'saturate(2000%)'
          ];
          ctx.filter = filters[Math.floor(Math.random() * filters.length)];

          // Fill with random pixel data
          let imgData = ctx.createImageData(canvas.width, canvas.height);
          for (let i = 0; i < imgData.data.length; i++) {
            imgData.data[i] = Math.floor(Math.random() * 256);
          }
          ctx.putImageData(imgData, 0, 0);

          // Encode to JPEG
          canvas.toBlob(blob => {
            const img = new Image();
            img.onload = () => {
              ctx.drawImage(img, 0, 0);
              log("[+] Re-rendered fuzzed JPEG image");
            };
            img.onerror = () => log("[!] JPEG decode failed");
            img.src = URL.createObjectURL(blob);
          }, 'image/jpeg');

        } catch (err) {
          log("[!] Exception: " + err.message);
        }
      }, 300);

      log("[*] Started canvas fuzzing");

      // Start getUserMedia for AVFoundation stress
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          document.getElementById("video").srcObject = stream;
          log("[*] Camera stream active");
        })
        .catch(err => log("[!] Camera error: " + err.message));

      // Add iframe to introduce DOM churn
      const iframe = document.createElement("iframe");
      iframe.srcdoc = "<p>Fuzz iframe</p><canvas width='512' height='512'></canvas>";
      document.body.appendChild(iframe);
      log("[*] Injected fuzz iframe");
    }

    function stopFuzzing() {
      clearInterval(loop);
      log("[*] Stopped fuzzing loop");
    }
  </script>
</body>
</html>
